/*! Compiled on: Thu May 21 2015 08:13:23 */
var fileVersion = "v1.0-4-f842d9e-dirty"; 
"use strict";define(["modules/app","storage","beacon","dishesFactory"],function(app){app.factory("ordersFactory",["$state","$q","$storage","$resource","$rootScope","config","$beacon","$modal","$loading","$timeout","dishesFactory",function($state,$q,$storage,$resource,$rootScope,config,$beacon,$modal,$loading,$timeout,dishesFactory){var self=this;$beacon.on("authentication.change",function(){$rootScope.incomplete_order=null}),$rootScope.$watch("incomplete_order",function(incomplete_order){incomplete_order&&(incomplete_order.totalItems=0,incomplete_order.item_ids=[],angular.forEach(incomplete_order.items,function(item){incomplete_order.totalItems+=item.quantity,incomplete_order.item_ids.push(item.id)})),$timeout(function(){$beacon.trigger("cart.updated",incomplete_order)},1500)});var removeItem=function(){var dish=this;dish.to_be_removed=!0;var deferred=$q.defer();return resource.removeDish({id:dish.order_id,order_item_id:dish.id,item_id:dish.item.id,token:dish.order_token},function(result){$rootScope.incomplete_order=format(result.data),$beacon.trigger("dish.removed")},function(){dish.to_be_removed=!1}),deferred.promise},editItem=function(order){var dish=this;$modal.open({templateUrl:"/release/html/modals/dishes/details.html",controller:"dishesDetailsCtrl",resolve:{dish:function(){return dish},order:function(){return order},onSuccess:function(){return null},is_update:function(){return!0}}})},strToDate=function(string){var parts=string.match(/(\d+)/g);return new Date(parts[0],parts[1]-1,parts[2],parts[3],parts[4],parts[5])},format=function(order){return order?(angular.forEach(order.items,function(item){item.ordered_dish&&(item.ordered_dish=dishesFactory.formatDish(item.ordered_dish),item.reorder_dish=dishesFactory.formatDish(item.reorder_dish)),item.order_id=order.id,item.order_token=order.source_token,item.remove=removeItem,item.edit=editItem}),order.delivered_at&&(order.delivered_at=strToDate(order.delivered_at)),order.cancel=cancel,order):null},cancel=function(){$rootScope.incomplete_order=null,$loading.start();var order=this;self.cancel(order.id).finally(function(){$loading.end()})};self.cancel=function(id){var deferred=$q.defer();return $rootScope.showCart=!1,$rootScope.incomplete_order&&(id=id||$rootScope.incomplete_order.id),id?(resource.delete({id:id},function(){$rootScope.incomplete_order=null,$beacon.trigger("orders.deleted"),deferred.resolve()}),deferred.promise):(deferred.resolve(),deferred.promise)},self.updateItem=function(data){var deferred=$q.defer();return resource.updateItem(data,function(result){deferred.resolve(result),$rootScope.incomplete_order=format(result.data)},function(error){deferred.reject(error)}),deferred.promise},self.add=function(data){var deferred=$q.defer(),order=$rootScope.incomplete_order;return order?(data.id=order.id,data.token=order.source_token,resource.add(data,function(result){$rootScope.incomplete_order=format(result.data),deferred.resolve(result)},function(error){deferred.reject(error)})):resource.create(data,function(result){$rootScope.incomplete_order=format(result.data),deferred.resolve(result)},function(error){deferred.reject(error)}),deferred.promise},self.submit=function(data){var deferred=$q.defer();return resource.submit(data,function(result){var order=result;deferred.resolve(order.data),$beacon.trigger("orders.placed",[order]),order.data.delivery_time=strToDate(order.data.delivered_at),$state.transitionTo("primary.account.orders"),$modal.open({windowClass:"order-confirm",templateUrl:"/release/html/modals/order/confirmation.html",controller:function($scope,order,$modalInstance){$scope.order=order,$rootScope.showCart=!1,$rootScope.itemCount=0,$scope.global.below_order_minimum=0,$scope.close=function(){$modalInstance.close()}},resolve:{order:function(){return order.data}}}),$rootScope.incomplete_order=null},function(response){deferred.reject(response.data)}),deferred.promise},self.get=function(page){var deferred=$q.defer();return resource.get({page:page},function(result){for(var i=0;i<result.data.length;i++)result.data[i]=format(result.data[i]);deferred.resolve(result)}),deferred.promise},self.create=function(data){var deferred=$q.defer();return resource.create(data,function(result){deferred.resolve(result)},function(error){deferred.reject(error)}),deferred.promise},self.getIncomplete=function(){var deferred=$q.defer();return resource.getIncomplete({},function(result){result.data?($rootScope.incomplete_order=format(result.data),deferred.resolve($rootScope.incomplete_order)):($rootScope.incomplete_order=null,deferred.resolve(null))}),deferred.promise};var resource=$resource(config.api+"/orders/:status/:id/:order_item_id/:action",{},{get:{method:"GET",authentication:!0},getIncomplete:{method:"GET",authentication:!0,params:{status:"incomplete"}},removeDish:{method:"DELETE",authentication:!0,params:{id:"@id",order_item_id:"@order_item_id",item_id:"@item_id",token:"@token"}},updateItem:{method:"PATCH",authentication:!0,params:{id:"@id",order_item_id:"@order_item_id",token:"@token"}},create:{method:"POST",authentication:!0},"delete":{method:"DELETE",authentication:!0},update:{method:"PUT",authentication:!0},submit:{method:"POST",authentication:!0,params:{action:"submit",id:"@id"}},add:{method:"PUT",authentication:!0,params:{id:"@id"}}});return self}])});