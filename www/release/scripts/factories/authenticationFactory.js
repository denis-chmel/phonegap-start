/*! Compiled on: Thu May 21 2015 09:01:22 */
var fileVersion = "v1.0-4-f842d9e-dirty"; 
define(["modules/app","utils/dependcyManager","usersFactory"],function(app,dependcyManager){app.factory("authenticationFactory",["config","$cachedResource","$q","$rootScope","$cookies","$http","usersFactory","$beacon","$error","$loading","$modal",function(config,$cachedResource,$q,$rootScope,$cookies,$http,usersFactory,$beacon,$error,$loading,$modal){var storeTokens=function(response){$cookies.set("access_token",response.access_token),$cookies.set("token_expiry",response.expires,new Date((new Date).getTime()+1e3*response.expires_in)),response.refresh_token&&$cookies.set("refresh_token",response.refresh_token)},success=function(data){storeTokens(data),$beacon.trigger("authentication.login"),$beacon.trigger("authentication.change",!0),$cachedResource.clearAll()},clearCacheInterval=6e5;config.devMode&&(clearCacheInterval=0),0==config.cache&&(clearCacheInterval=3e3),clearCacheInterval&&($cachedResource.clearAll(),setInterval(function(){$cachedResource.clearAll()},clearCacheInterval));var transform=function(data){var parts=[];for(var key in data)data.hasOwnProperty(key)&&parts.push(escape(key)+"="+encodeURIComponent(data[key]));return parts.join("&")};return self.refreshAccessToken=function(){var deferred=$q.defer();return $http({method:"POST",data:{grant_type:"refresh_token",refresh_token:$cookies.get("refresh_token")},url:"/refresh",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform}).success(function(data){storeTokens(data),deferred.resolve()}).error(function(){$cookies.remove("access_token"),$cookies.remove("refresh_token"),$cookies.remove("token_expiry"),$rootScope.$broadcast("loginRequired"),deferred.reject()}),deferred.promise},self.me=function(){var deferred=$q.defer();return $cookies.get("access_token")&&$cookies.get("refresh_token")&&$cookies.get("token_expiry")||deferred.reject(),usersFactory.getCurrentUserFromAPI().then(function(user){deferred.resolve(user)},function(){deferred.reject()}),deferred.promise},$rootScope.forgotDetails=function(email){$modal.open({templateUrl:"/release/html/modals/account/forgotDetails.html",windowClass:"forgot-details center-on-mobile",controller:"forgotDetailsCtrl",resolve:{controller:dependcyManager.resolve("controllers/forgotDetailsCtrl"),email:function(){return email}}})},self.signout=function(){$cookies.remove("access_token"),$cookies.remove("refresh_token"),$cookies.remove("token_expiry"),usersFactory.removeCurrentUser(),$beacon.trigger("authentication.change",!1),$beacon.trigger("authentication.logout"),$loading.end()},self.facebook=function(){},self.signIn=function(data){var deferred=$q.defer();return $loading.start(),$http({method:"POST",data:{username:data.email,password:data.password,grant_type:"password"},url:"/signin",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform}).success(function(response){$loading.end(),"access_token"in response?(success(response),deferred.resolve()):($error.alert("authentication",response.data||"An unknown error occured during authentification, please try later."),deferred.reject())}).error(function(response){$loading.end(),$error.alert("authentication",response.error),deferred.reject()}),deferred.promise},self.signUp=function(data){var deferred=$q.defer(),utmzCookie=$cookies.get("__utmz")||"",isAdwordsUser=utmzCookie.match(/utmgclid=/);return $http({method:"POST",data:{username:data.email,password:data.password,first_name:data.first_name,last_name:data.last_name,is_from_adwords:isAdwordsUser?utmzCookie:null,type:void 0===data.type?"user":data.type,account_type:"email",grant_type:"bask"},url:"/signup",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform}).success(function(data){"access_token"in data?(success(data),deferred.resolve()):(console.log("There was an error"),deferred.reject())}).error(function(data){$error.alert("authentication",data.error),deferred.reject()}),deferred.promise},self}])});