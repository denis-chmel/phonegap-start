/*! Compiled on: Thu May 21 2015 08:13:23 */
var fileVersion = "v1.0-4-f842d9e-dirty"; 
"use strict";define(["modules/app","inflectionjs","usersFactory"],function(app){app.factory("dishesFactory",["config","$q","$cachedResource","$rootScope","$modal","$beacon","usersFactory",function(config,$q,$cachedResource,$rootScope,$modal,$beacon,usersFactory){var self=this,path=config.api+"/dishes";self.like=function(dish){return self.rate(dish,"like")},self.rate=function(dish,rating){return resource.rate({id:dish.id,rating:rating}).$promise},self.dislike=function(dish){var dislike_keywords=[],neutral_keywords=[];for(var j in dish.keywords)if(dish.keywords.hasOwnProperty(j)){var keyword=dish.keywords[j].text;$rootScope.user.isDislikingIngredient(keyword,dish.keywords[j].dislike),dish.keywords[j].dislike?dislike_keywords.push(keyword):neutral_keywords.push(keyword)}var dislike_cuisines=[],neutral_cuisines=[];for(var k in dish.restaurant.cuisines)if(dish.restaurant.cuisines.hasOwnProperty(k)){var cuisine=dish.restaurant.cuisines[k];$rootScope.user.isDislikingCuisine(cuisine.text,cuisine.dislike),cuisine.dislike?dislike_cuisines.push(cuisine.text):neutral_cuisines.push(cuisine.text)}$rootScope.user.isDislikingRestaurant(dish.restaurant,dish.restaurant.dislike),$rootScope.user.removeFromFavoritesList(dish);var deferred=resource.rate({id:dish.id,dislike_restaurant:dish.restaurant.dislike?1:0,dislike_keywords:dislike_keywords,neutral_keywords:neutral_keywords,dislike_cuisines:dislike_cuisines,neutral_cuisines:neutral_cuisines,rating:"dislike"});return $beacon.trigger("tastes.changed"),deferred.$promise},$beacon.on("tastes.changed",function(){resource.$clearAll()}),self.view=function(params){resource.view(params)},self.formatDish=function(dish){if(!dish)return console.error("dish param is empty in formatDish. That is nonsense"),[];var filterUniqueAndShort=function(array){var u={},a=[],neverFilterWordsString="egg ham pea cod lox eel jam yam oat nut blt pbj bar pie tea bun ice",neverFilterWords=neverFilterWordsString.split(" "),filterWords=$rootScope.user.negative_stop_words;String.prototype._uncountable_words=$rootScope.user.uncountable_words;for(var tooShort=3,i=0,l=array.length;l>i;++i){var value=array[i];if(value=value.replace(/'s$/,""),value=value.replace(/[\.,)(:!?]*/g,""),value=value.singularize().toLowerCase(),(value.length>tooShort||neverFilterWords.indexOf(value)>-1)&&-1==filterWords.indexOf(value)){if(u.hasOwnProperty(value))continue;a.push(value)}u[value]=1}for(var j=0;j<a.length;j++)a[j]=a[j].capitalize();return a};dish.keywords=[];var tags=dish.tags;"string"==typeof tags&&(tags=tags.split(","));var keywords=tags||[];keywords=keywords.concat([dish.name,dish.description].join(" ").split(" ")),keywords=filterUniqueAndShort(keywords);for(var i in keywords)if(keywords.hasOwnProperty(i)){var isDisliked=$rootScope.user.isDislikingIngredient(keywords[i]);dish.keywords.push({text:keywords[i],dislike:isDisliked})}var available_days=[];if(dish.is_available_now=!0,dish.schedule&&dish.schedule.length){dish.is_available_now=dish.schedule[0].is_available_now,available_days=dish.schedule.filter(function(day){return day.is_available_today});for(var day in available_days)if(available_days.hasOwnProperty(day)){var intervalsAsStrings=[],intervals=available_days[day].intervals;for(var interval in intervals)intervals.hasOwnProperty(interval)&&(intervals[interval].is_in_past||intervalsAsStrings.push(intervals[interval].starts+" â€” "+intervals[interval].ends));available_days[day].intervalString=intervalsAsStrings.join(" or ")}}return dish.available_days=available_days.filter(function(value){return value.intervalString.length}),dish.address_id=self.address_id,dish};var getRestaurantInfo=function(dishes){var restaurant_ids=[];angular.forEach(dishes,function(dish){dish.restaurant.images=[{},{},{},{}],restaurant_ids.push(dish.restaurant.id)}),angular.forEach($.unique(restaurant_ids),function(restaurant_id){restaurant_resource.get({id:restaurant_id},function(response){dishes.map(function(dish){dish.restaurant.id==restaurant_id&&angular.extend(dish.restaurant,response)})})})};self.getLiked=function(){return resource.liked().$promise},self.getDisliked=function(){return resource.disliked().$promise},self.getFavorites=function(initialParams){var deferred=$q.defer(),params={page:initialParams.page,time:initialParams.time,keyword:initialParams.keyword};return initialParams.location&&(params.location=[initialParams.location.address,initialParams.location.city,initialParams.location.state,initialParams.location.zip].join(" "),self.address_id=initialParams.location.id),usersFactory.favorites.get(params,function(result){if(!initialParams.facets_mode){var dishes=[];for(var i in result.data.results)result.data.results.hasOwnProperty(i)&&dishes.push(self.formatDish(result.data.results[i]));getRestaurantInfo(dishes),deferred.resolve({dishes:dishes,response:result.data})}}),deferred.promise},self.getDishesForSurvey=function(params){var deferred=$q.defer();return survey_resource.get(params,function(results){var dishes=[];angular.forEach(results,function(dish){dishes.push(self.formatDish(dish))}),deferred.resolve(dishes)},function(response){deferred.reject(response)}),deferred.promise},self.get=function(initial_params){var deferred=$q.defer(),params=angular.copy(initial_params);return params.location?self.address_id=params.location.id:params.location_id&&(self.address_id=params.location_id),params.location&&(params.location=params.location.address+" "+params.location.city+" "+params.location.state+" "+params.location.zip),self.params=params,resource.get(params,function(result){if("undefined"==typeof result.data)return void deferred.reject();var dishes=[];result.data.results&&result.data.results.sort(function(a,b){return a.restaurant_id-b.restaurant_id});for(var i in result.data.results)result.data.results.hasOwnProperty(i)&&dishes.push(self.formatDish(result.data.results[i]));getRestaurantInfo(dishes),deferred.resolve({dishes:dishes,response:result.data})},function(response){deferred.reject(response)}),deferred.promise},self.getSamples=function(){var deferred=$q.defer();return resource.samples({},function(results){for(var samples=[],i=0;i<results.length;i++)samples.push(self.formatDish(results[i]));deferred.resolve(samples)}),deferred.promise},self.trackItemView=function(dish){resource.track(dish)};var restaurant_resource=$cachedResource("restaurants",config.api+"/restaurants/:id",{id:"@id"},{get:{method:"GET",authentication:!0}}),survey_resource=$cachedResource("survey_dishes",path+"/survey/:id",{id:"@id"},{get:{method:"GET",authentication:!0,isArray:!0,params:{id:"@id"}}}),resource=$cachedResource("dishes",path+"/:samples/:disliked/:liked/:track/:detail/:id",{id:"@id",price_lte:"@price_lte",max_min_order:"@max_min_order",keyword:"@keyword"},{samples:{method:"GET",authentication:!0,isArray:!0,params:{samples:"samples"}},liked:{method:"GET",authentication:!0,isArray:!0,params:{samples:"liked"}},disliked:{method:"GET",authentication:!0,isArray:!0,params:{samples:"disliked"}},track:{method:"PUT",authentication:!0,params:{track:"track",detail:"detail",id:"@id"}},view:{method:"PUT",authentication:!0,params:{track:"track",detail:"list"}},rate:{method:"PUT",authentication:!0,params:{id:"@id"}},get:{method:"GET",authentication:!0,params:{id:"@id"}},update:{method:"PUT",authentication:!0}});return self}])});