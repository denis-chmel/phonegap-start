/*! Compiled on: Thu May 21 2015 08:13:23 */
var fileVersion = "v1.0-4-f842d9e-dirty"; 
"use strict";define(["modules/app","ordersFactory","iCheck","controllers/dishesDetailsCtrl","dishesFactory","customScroll","tooltip"],function(app){app.controllerManager("accountOrdersCtrl",["$scope","$rootScope","$q","$location","ordersFactory","$loading","$filter","$state","$error","dishesFactory","$modal",function($scope,$rootScope,$q,$location,ordersFactory,$loading,$filter,$state,$error,dishesFactory,$modal){$scope.data={orders:[],current_page:1,last_page:1,in_progress:!1},$scope.loadOrders=function(page){page=page||1,$loading.start(),$q.all([ordersFactory.get(page)]).then(function(response){$scope.data.orders=$scope.data.orders.concat(response[0].data),$scope.data.current_page=response[0].current_page,$scope.data.last_page=response[0].last_page;for(var i=0;i<$scope.data.orders.length;i++)for(var k=0;k<$scope.data.orders[i].items.length;k++)"undefined"!=typeof $location.search().item_id&&"undefined"!=typeof $location.search().rating&&$scope.data.orders[i].items[k].id==$location.search().item_id&&("like"==$location.search().rating?($scope.like($scope.data.orders[i].items[k]),$error.success("rating","Thanks for rating your dish.")):$scope.dislike($scope.data.orders[i].items[k]));$location.search("item_id",null),$location.search("rating",null),$loading.end()})},$scope.loadOrders(),$scope.choose=function(order){order.reorder=!1;for(var i=0;i<order.items.length;i++)order.items[i].reorder&&(order.reorder=!0)},$scope.like=function(item){item.rating="like",dishesFactory.like(item.ordered_dish).then(function(){$location.search({})})},$scope.dislike=function(item){$modal.open({templateUrl:"/release/html/modals/dishes/dislike.html",controller:["$scope","$modalInstance","$timeout",function($modalScope,$modalInstance,$timeout){$modalScope.dish=dishesFactory.formatDish(item.ordered_dish),$(window).off("resize.dislikeDialog").on("resize.dislikeDialog",function(){if($rootScope.isMobileMode()){var modal=$(".modal.current .modal-dialog");$modalScope.choicesHeight=window.innerHeight-modal.height()+modal.find(".limited-height").height(),$modalScope.choicesMaxHeight=null}else $modalScope.choicesHeight=null,$modalScope.choicesMaxHeight=window.innerHeight-350});var initHeights=function(){var modal=$(".modal.current");modal.length?$(window).resize():$timeout(initHeights,100)};initHeights(),$modalScope.submit=function(){dishesFactory.dislike(item.item).then(function(){$location.search({})}),$error.success("rating","Thanks for rating your dish."),item.rating="dislike",$modalInstance.close()}}]})};var addDishToCart=function(params){var deferred=$q.defer();return $loading.start(),ordersFactory.add(params).then(function(response){$loading.end(),deferred.resolve(response)},function(response){$loading.end(),deferred.reject(response.data.error)}),deferred.promise};$scope.dishDetailsModal=function(order_item,order){var getDish=function(dish_id){return $loading.start(),dishesFactory.get({location_id:order_item.address_id,id:dish_id}).catch(function(response){$error.alert(null,response.data.data)}).finally(function(){$loading.end()})};$location.search("id",order_item.menu_item_id),getDish(order_item.menu_item_id).then(function(result){var dish=result.dishes[0];dish.notes=order_item.notes,dish.quantity=order_item.quantity,$modal.open({windowClass:"fullscreen-on-mobile",templateUrl:"/release/html/modals/dishes/details.html",controller:"dishesDetailsCtrl",resolve:{dish:function(){return dish},order:function(){return!1},onSuccess:function(){return function(){order_item.reorder=!1,$scope.submit(order)}},is_update:function(){return!1}}})})},$scope.submit=function(order){order.is_transferred=null!=order.reorder_restaurant_id,$loading.start();var next_order_item=null;return angular.forEach(order.items,function(item){item.reorder&&!next_order_item&&(next_order_item=item)}),next_order_item?(next_order_item.address_id=order.address?order.address.id:$scope.user.address.id,next_order_item.restaurant_id=order.restaurant_id,next_order_item.option_ids=next_order_item.options,order.is_transferred&&(next_order_item.restaurant_id=order.reorder_restaurant_id,next_order_item.menu_item_id=next_order_item.reorder_dish.id),void(order.is_transferred&&next_order_item.options?($error.warning(null,"The options for this dish are outdated, please make your selections again."),$scope.dishDetailsModal(next_order_item,order)):addDishToCart(next_order_item).then(function(){next_order_item.reorder=!1,$scope.submit(order)},function(){$scope.dishDetailsModal(next_order_item,order)}))):void $state.transitionTo("primary.dishes").then(function(){$error.success(null,"The selected items were added to your cart, place the order whenever you're ready!")})}}])});