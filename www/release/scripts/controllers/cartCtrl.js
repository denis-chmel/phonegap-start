/*! Compiled on: Thu May 21 2015 08:13:23 */
var fileVersion = "v1.0-4-f842d9e-dirty"; 
"use strict";define(["modules/app","checkbox","select","ordersFactory","cardsFactory","beacon","numeric","maskedInput","iCheck"],function(app){app.controllerManager("cartCtrl",["$scope","$rootScope","$state","$currentUser","ordersFactory","cardsFactory","$beacon","$loading","$error","$timeout","$modal",function($scope,$rootScope,$state,$currentUser,ordersFactory,cardsFactory,$beacon,$loading,$error,$timeout,$modal){var is_business_class=$scope.user&&$scope.user.address&&$scope.user.address.group_id,defaults={tip:2,used_tip:2,order_type:is_business_class?"Group":"Delivery",order_delivery_fee:0,order_total:0};$scope.order=null,$scope.cart={tip:defaults.tip,order_total:0},$scope.data={credit_card:{}},$scope.cards=[];var reloadCards=function(){cardsFactory.getList().then(function(result){$scope.cards=result,$scope.data.credit_card=$scope.cards.length?$scope.cards[0]:{}})};$beacon.on("card.touched",reloadCards),$rootScope.alwaysShowCart=!1,$rootScope.$watch("cartEnabled",function(){updateCartVisibility()});var updateCartVisibility=function(){$rootScope.hideCart=!1,$timeout(function(){$rootScope.showCart||$rootScope.alwaysShowCart||($rootScope.hideCart=!0)},500)};updateCartVisibility();var recalculateOrderLines=function(){if($scope.order){var deliveryFee=$scope.order.delivery;$scope.cart.used_tip="Delivery"==$scope.cart.order_type?parseFloat($scope.cart.tip):0,$scope.cart.order_total=parseFloat($scope.order.total)+$scope.cart.used_tip,$scope.cart.order_delivery_fee=deliveryFee,"Pickup"==$scope.cart.order_type&&($scope.cart.order_delivery_fee=0,$scope.cart.order_total-=deliveryFee)}};$scope.$watch("cart.order_type",recalculateOrderLines),$scope.$watch("cart.tip",recalculateOrderLines),$scope.$watch("user.address",function(address){$scope.cart.order_type=address&&address.group_id?"Group":"Delivery"}),reloadCards(),$beacon.on("cart.updated",function(incomplete_order){if(incomplete_order)$scope.order=incomplete_order,$rootScope.itemCount=$scope.order.items.length,$scope.global.below_order_minimum=Math.max(0,$scope.order.minimum-$scope.order.subtotal),$scope.user.address=incomplete_order.address,recalculateOrderLines();else{$rootScope.itemCount=0,$scope.global.below_order_minimum=0,$rootScope.showCart=!1,$scope.cart=angular.copy(defaults);for(var prop in $scope.order)$scope.order.hasOwnProperty(prop)&&($scope.order[prop]=null);$scope.order=null,reloadCards(),$scope.cart_form.$setPristine()}}),$beacon.on("authentication.logout",function(){$scope.data.credit_card={},$scope.cards=[]}),$beacon.on("authentication.login",function(){$scope.global.below_order_minimum=0,$rootScope.itemCount=0,reloadCards(),$scope.cart=angular.copy(defaults)}),$rootScope.scrollToCC=function(){var orderDetailsBlock=$("#cart-order-details");orderDetailsBlock.length&&$timeout(function(){$("body, html").stop().animate({scrollTop:orderDetailsBlock.offset().top},500)})},$scope.boldFirstWord=function(phrase){var words=phrase.split(" ");return words[0]&&(words[0]="<b>"+words[0]+"</b>"),words.join(" ")},$scope.showCVVHelp=function(){$modal.open({templateUrl:"/release/html/modals/cvv.html",controller:function($scope,$modalInstance){$scope.close=function(){$modalInstance.close()}}})},$rootScope.toggleCart=function(visible,scrollToDetails){$rootScope.showCart="undefined"!=typeof visible?visible:!$rootScope.showCart,scrollToDetails&&$rootScope.showCart&&$rootScope.alwaysShowCart&&$rootScope.scrollToCC(),updateCartVisibility(),$rootScope.showCart&&$beacon.trigger("cart.opened")},$scope.remove=function(item){1===$scope.order.items.length?$scope.order.cancel():item.remove()},$scope.placeOrder=function(){var form=this;if(form.submitted=!0,$timeout(function(){form.submitted=!1},2e3),!$scope.user.address.phone)return void $error.alert("payment","Please provide a phone number");if($scope.cart_form.$invalid)return void $error.alert(null,"Please complete all fields");Modernizr.touch&&$timeout(function(){$("body").scrollTop(0)});var overrideData={},orderSubmitData={id:$scope.order.id,token:$scope.order.source_token,payment:"creditcard",tipMethod:"creditcard",pickup:"Pickup"==$scope.cart.order_type,tip:$scope.cart.used_tip,phone:$scope.user.address.phone,total:$scope.cart.order_total};if($scope.cart.order_total){var newCard;if($scope.data.credit_card.id){if(!$scope.data.credit_card.cvv)return void $error.alert("payment","Please enter a proper CVV for this card");overrideData={payment:"saved_creditcard",credit_card_id:$scope.data.credit_card.id,cccvv:$scope.data.credit_card.cvv}}else{var expdate=this.cart_form.expdate.$modelValue.match(/.{1,2}/g),expire_month=expdate[0],expire_year=expdate[1];newCard={save:this.cart_form.save_card.$modelValue!==!1,card_number:this.cart_form.cardnumber.$modelValue,expire_month:expire_month,expire_year:expire_year,zip:this.cart_form.zip.$modelValue,cvv:this.cart_form.cccvv.$modelValue},overrideData={ccnumber:newCard.card_number,ccexpiration:newCard.expire_month+"/"+newCard.expire_year,cczip:newCard.zip,cccvv:newCard.cvv}}orderSubmitData=angular.extend(orderSubmitData,overrideData)}$loading.start(),ordersFactory.submit(orderSubmitData).then(function(){$loading.end(),newCard&&newCard.save&&cardsFactory.add(newCard)},function(response){var error="Unexpected crash: "+JSON.stringify(response);response.data&&(error=response.data),$error.alert(null,error),$loading.end()})}}])});