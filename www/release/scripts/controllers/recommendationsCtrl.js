/*! Compiled on: Thu May 21 2015 08:13:23 */
var fileVersion = "v1.0-4-f842d9e-dirty"; 
"use strict";define(["modules/app","utils/dependcyManager","checkbox","controllers/dishesDetailsCtrl","mixpanelFactory","dishesFactory","cuisinesFactory","usersFactory","select","rangesliderjs","truncate","welcomeTour","tooltip","fancybox","customScroll"],function(app,dependcyManager){app.controllerManager("recommendationsCtrl",["config","$scope","$rootScope","$state","mixpanelFactory","dishesFactory","authenticationFactory","cuisinesFactory","$q","$modal","$beacon","usersFactory","$location","ordersFactory","$timeout","$loading","$error","$cookies","$interval",function(config,$scope,$rootScope,$state,mixpanelFactory,dishesFactory,authenticationFactory,cuisinesFactory,$q,$modal,$beacon,usersFactory,$location,ordersFactory,$timeout,$loading,$error,$cookies,$interval){$rootScope.state="dishes",$timeout(function(){$rootScope.show_splash=!0}),$scope.dishWidth=313,$scope.Math=Math,$scope.cardBaseHeight=325,$scope.section={},$scope.cuisine={},$scope.isFullMenu=!1,$scope.restaurant=$.isEmptyObject($scope.incomplete_order)?{}:$scope.incomplete_order.restaurant,angular.extend($scope.data,{modal_filters_mode:!1,maxMinPrice:config.maxMinPrice,maxMinOrder:config.maxMinOrder,restaurants_count:0,total_records:0,prev_records:0,sections:[],restaurants:[],time_left:0,cuisines:[],filters:{},max_per_page:15,page_extra:{},page:($location.search().page||1)-1,all_sections_label:"",unapplied_filters:{price_lte:null,max_min_order:null,keyword:null}});var dishesReloadDelay=200,healthyCookieName="healthy-"+$rootScope.user.id;$scope.isFavoritesPage="primary.wishlist"==$state.current.name;var getFiltersFromUrl=function(ignore_params){var filters={};ignore_params=ignore_params||[];var keyword=($location.search().search||"").replace(/\+/g," ");keyword&&(filters.keyword=keyword);var cuisine_id=parseInt($location.search().cuisine)||null;cuisine_id&&(filters.cuisine_id=cuisine_id);var restaurant_id=parseInt($location.search().restaurant)||null;return restaurant_id&&-1==ignore_params.indexOf("restaurant_id")&&(filters.restaurant_id=restaurant_id,$scope.restaurant.id||($scope.restaurant={id:restaurant_id})),$location.search().section&&(filters.section_id=$location.search().section),$location.search().price&&(filters.price_lte=$location.search().price),$location.search().order&&(filters.max_min_order=$location.search().order),$location.search().healthy&&(filters.healthy={checked:!0}),$location.search().id&&(filters.dish_id=$location.search().id),$location.search().location&&(filters.location_id=parseInt($location.search().location)||null),filters},setFiltersInUrl=function(filters){var priceParam=filters.price_lte||null;priceParam==config.maxMinPrice&&(priceParam=null);var orderParam=filters.max_min_order||null;orderParam==config.maxMinOrder&&(orderParam=null);var section=filters.section_id||null;section==$scope.data.all_sections_label&&(section=null),filters.healthy.checked?($location.search("healthy",1),$scope.isFavoritesPage||$cookies.set(healthyCookieName,!0)):($location.search("healthy",null),$scope.isFavoritesPage||$cookies.remove(healthyCookieName)),$scope.data.all_sections_label=filters.restaurant_id?"Recommended for You":"All Sections",$location.search(angular.extend($location.search(),{cuisine:filters.cuisine_id,restaurant:filters.restaurant_id||null,section:section,search:filters.keyword||null,price:priceParam,order:orderParam,id:filters.dish_id||null,location:null})),$location.path($location.$$path).replace()};$beacon.on("authentication.change",function(){$cookies.remove(healthyCookieName)});var getRecommendedFilters=function(){var recommendedParams={healthy:{checked:$cookies.has(healthyCookieName)}};if($.isEmptyObject($scope.incomplete_order)&&!$scope.isFavoritesPage){var current_hour=(new Date).getHours();recommendedParams.section_id=current_hour>=4&&11>current_hour?"Breakfast":"Entrees"}return recommendedParams};$scope.isFavoritesPage&&mixpanelFactory.track("FavoritesPage Visit"),$scope.getPriceFilterValue=function(){var result=parseInt($scope.data.filters.price_lte);return result>=config.maxMinPrice&&(result=null),result},$scope.getMinOrderFilterValue=function(){var result=parseInt($scope.data.filters.max_min_order);return result>=config.maxMinOrder&&(result=null),result};var getDish=function(dish_id){return $loading.start(),dishesFactory.get({location:$scope.user.address,location_id:$scope.user.address.id,healthy:$scope.data.filters.healthy.checked?1:0,time:$location.search().time,id:dish_id}).catch(function(response){$error.alert(null,response.data.data)}).finally(function(){$loading.end()})};$scope.showReviews=function(dish){$modal.open({windowClass:"fullscreen-on-mobile",templateUrl:"/release/html/modals/dishes/reviews.html",controller:function($scope,$modalInstance){$scope.dish=dish,$scope.close=function(){$modalInstance.close()}}})},$scope.dishDetailsModal=function(dish){var showModal=function(dish){return dish.is_orderable?(dishesFactory.trackItemView(dish),void $modal.open({windowClass:"fullscreen-on-mobile",templateUrl:"/release/html/modals/dishes/details.html",controller:"dishesDetailsCtrl",resolve:{dish:function(){return dish},order:function(){return!1},onSuccess:function(){return null},is_update:function(){return!1}}})):void $modal.open({templateUrl:"/release/html/modals/dishes/unavailable.html",controller:function($scope,$modalInstance){$scope.dish=dish,$scope.searchKeyword=$location.search().search,$scope.close=function(){$modalInstance.close()}}})};$location.search("id",dish.id),"undefined"==typeof dish.choices?getDish(dish.id).then(function(result){var dish=result.dishes[0];showModal(dish)}):showModal(dish)},$rootScope.seeFullMenu=function(restaurant){$scope.isFavoritesPage&&($scope.isFavoritesPage=!1),$scope.resetFilters([],{restaurant_id:restaurant.id,healthy:$scope.data.filters.healthy},!0,!0),$rootScope.scrollToTop(1)};var dishesReloadTimer,initRangeSliders=function(mobile_mode){$('input[type="range"]').each(function(){var self=this,queueUpdate=function(ms){mobile_mode||($timeout.cancel(self.timer),self.timer=$timeout(function(){$scope.resetFilters(null,$scope.data.unapplied_filters),getRestaurantsAndSectionsWithCounts(null,"price slider changed")},ms))};$(self).rangeslider({polyfill:!1,onSlideEnd:function(){queueUpdate()},onInit:function(){$(self).data("oldValue",this.$element.val())}}).change(function(e,silent_change){$(this).val()!=$(this).data("oldValue")&&($(this).data("oldValue",$(this).val()),silent_change||queueUpdate(dishesReloadDelay-1))})})},scheduleDishesReload=function(reason,page){$scope.user.address&&($scope.isAlreadyLoading=!0,$timeout.cancel(dishesReloadTimer),dishesReloadTimer=$timeout(function(){$scope.reloadDishes(page)},dishesReloadDelay))};$scope.applyFilters=function(){$scope.toggleMoreFilters(0),angular.extend($scope.data.filters,$scope.data.unapplied_filters)};var reconsiderFiltersInModal=function(){$scope.data.modal_filters_mode!=$scope.showFiltersInModal()&&($scope.data.modal_filters_mode=$scope.showFiltersInModal(),$rootScope.modal_filters_mode=$scope.showFiltersInModal(),$timeout(function(){initRangeSliders()}))};$scope.toggleMoreFilters=function(visible){reconsiderFiltersInModal(),$rootScope.openFilters="undefined"!=typeof visible?visible:!$rootScope.openFilters,$rootScope.openFilters&&$timeout(function(){initRangeSliders()}),$timeout(function(){windowOnResize()},500)},$beacon.on("cart.opened",function(){$scope.toggleMoreFilters(!1)}),$scope.toggleFavorite=function(dish,silent){$rootScope.user.toggleFavorite(dish).then(function(){if(!silent){var action=dish.favorited?"added to":"removed from";$error.success("update","Successfully "+action+" favorites. Updating your recommendations.",15e3,function(){$scope.toggleFavorite(dish,!0)})}$scope.reloadDishes()})},$scope.resetFilters=function(resetParams,applyParams,ignoreUrlParams,dontCascade){var self=this;if(!self.dontCascade){resetParams=resetParams||[],applyParams=applyParams||{};var defaultFilters={price_lte:config.maxMinPrice,max_min_order:config.maxMinOrder,keyword:"",healthy:{checked:!1},cuisine_id:null,location_id:$scope.user.address?$scope.user.address.id:null,restaurant_id:$scope.incomplete_order?$scope.incomplete_order.restaurant.id:null,section_id:null};$scope.incomplete_order||($rootScope.session.last_selected_section_id=null),$rootScope.session.last_selected_section_id&&!$scope.isFavoritesPage&&-1==resetParams.indexOf("section_id")&&(defaultFilters.section_id=$rootScope.session.last_selected_section_id);var filtersToApply=angular.copy(defaultFilters);if(!ignoreUrlParams){var filters=getFiltersFromUrl(resetParams);angular.extend(filtersToApply,filters)}if(resetParams.length)for(var i in resetParams)if(resetParams.hasOwnProperty(i)){var type=resetParams[i];filtersToApply[type]=angular.copy(defaultFilters[type])}angular.extend(filtersToApply,applyParams),setFiltersInUrl(filtersToApply),self.dontCascade=dontCascade,$scope.data.filters=filtersToApply,$timeout(function(){self.dontCascade=!1}),scheduleDishesReload("filters were reset")}};var overrideParams={};!$scope.isFavoritesPage&&$.isEmptyObject(getFiltersFromUrl())&&(overrideParams=getRecommendedFilters()),$scope.resetFilters(null,overrideParams),$("body")[0].scrollTop=0,$scope.showFiltersInModal=function(){return $(window).width()<=768},$beacon.on("dish.removed",function(){$scope.dish=null}),$beacon.on("orders.deleted",function(){$scope.dish=null,$scope.resetFilters(null,getRecommendedFilters(),!0,!0),$rootScope.scrollToTop(1),scheduleDishesReload("orders.deleted")}),$beacon.on("dish.added",function(result){$scope.isFavoritesPage=!1;var dish=result[0],incomplete_order=result[1];if($scope.dish=dish,$scope.isAlreadyLoading=!0,$scope.dishes=[],$rootScope.scrollToTop(1),1==incomplete_order.items.length)getRestaurantsAndSectionsWithCounts({restaurant_id:$scope.incomplete_order.restaurant.id},"1st dish added").then(function(){var afterSectionName=dish.section_name==$scope.data.sections[0].name?dish.section_name:null,section=getFirstNonEmptySection($scope.data.sections,afterSectionName),filters=getRecommendedFilters();filters.section_id=section.id,$scope.resetFilters(null,filters,!0,!0),0==$rootScope.user.orders_count&&1==$scope.incomplete_order.items.length&&$timeout(function(){$rootScope.isMobileMode()||($scope.first_dish_tour_start=!0)},1e3)});else{var section=getFirstNonEmptySection($scope.data.sections,dish.section_name),filters=getRecommendedFilters();filters.section_id=section.id,$scope.resetFilters(null,filters,!0,!0)}});var windowOnResize=function(){};$timeout(function(){windowOnResize()},500),$(window).off(".dishes").on("resize.dishes onorientationchange.dishes",windowOnResize);var getFirstNonEmptySection=function(sections,afterSectionName){for(var afterCurrent=!afterSectionName,i=0;i<sections.length;i++){if(afterCurrent&&sections[i].count)return sections[i];sections[i].name==afterSectionName&&(afterCurrent=!0)}return sections[0]};$scope.isLastPage=function(){return $scope.data.prev_records+$scope.dishes.length>=$scope.data.total_records};var getDishes=function(incoming_params){incoming_params=incoming_params||{};var params={location:$scope.user.address,location_id:$scope.user.address.id,cuisine:$scope.data.filters.cuisine_id,section:$scope.data.filters.section_id,section_id:parseInt($scope.data.filters.section_id),keyword:$scope.data.filters.keyword,price_lte:$scope.data.filters.price_lte,max_min_order:$scope.data.filters.max_min_order,healthy:$scope.data.filters.healthy.checked?1:0,restaurant:incoming_params.restaurant_id||$scope.data.filters.restaurant_id,facets_mode:incoming_params.facets_mode||0,time:$location.search().time,source:$location.search().source,test:$location.search().test,page:$scope.data.page};params.price_lte&&params.price_lte>=config.maxMinPrice&&delete params.price_lte,params.max_min_order&&params.max_min_order>=config.maxMinOrder&&delete params.max_min_order,params.facets_mode||(params.page||($scope.data.total_records=0,$scope.data.prev_records=0),$location.search("page",params.page?params.page+1:null)),$scope.dishes=[];for(var addSlots=$scope.data.max_per_page;addSlots-->0;)$scope.dishes.push({id:null});var result;return $scope.isFavoritesPage?result=dishesFactory.getFavorites(params):(result=dishesFactory.get(params),params.facets_mode||result.then(function(response){$timeout(function(){$scope.welcome_tour_start=!1},1e3),$scope.data.page_extra=response.response.extra,angular.extend($rootScope.session.mixpanel_properties,response.response.stats),mixpanelFactory.track("Items view",{section:$scope.data.filters.section_id,restaurant_id:$scope.data.filters.restaurant_id,restaurant:$scope.data.filters.restaurant_id?$scope.restaurant.name:null,section_id:$scope.data.filters.section_id,cuisine_id:$scope.data.filters.cuisine_id,cuisine:$scope.cuisine.name||null,healthy:$scope.data.filters.healthy.checked?"yes":"no",keyword:$scope.data.filters.keyword.length?"yes":"no",price_lte:$scope.getPriceFilterValue(),max_min_order:$scope.getMinOrderFilterValue(),resultsCount:response.response.total})})),params.facets_mode||(result.then(function(response){$scope.data.prev_records=($scope.data.page||0)*$scope.data.max_per_page,$scope.data.restaurants_count=response.response.restaurants_count,$scope.data.total_records=response.response.total_records}),result.catch(function(response){var message="Unexpected response from /dishes endpoint";response&&response.data&&response.data.data&&(message=response.data.data),$error.alert(null,message)}),result.finally(function(){$loading.end(),$scope.isFullMenu=params.restaurant&&!params.section_id})),result},getRestaurantsAndSectionsWithCounts=function(params,reason){console.info("Updating restaurants/sections dropdowns due to: "+reason),params=params||{},params.facets_mode=1;var update_sections=!0;return $scope.restaurant||params.restaurant_id||($scope.data.sections=$rootScope.user.generic_sections,update_sections=!1),getDishes(params).then(function(response){if(update_sections)if(response.response.facets.sections){if($scope.data.sections=response.response.facets.sections,$scope.data.sections&&$scope.data.filters.section_id){var needleSection=$scope.data.sections.filter(function(section){return(section.id||section.name)==$scope.data.filters.section_id});$scope.section=needleSection[0]}}else console.error("No sections facet in response: ",response);if($scope.data.restaurants=response.response.facets.restaurants||[],$scope.data.filters.restaurant_id){var needleRestaurant=$scope.data.restaurants.filter(function(restaurant){return restaurant.id==$scope.data.filters.restaurant_id});needleRestaurant[0]&&($scope.restaurant=needleRestaurant[0])}})};cuisinesFactory.getAll().then(function(response){if($scope.data.cuisines=response||[],$scope.data.filters.cuisine_id){var needleCuisine=$scope.data.cuisines.filter(function(cuisine){return cuisine.id==$scope.data.filters.cuisine_id});needleCuisine[0]&&($scope.cuisine=angular.copy(needleCuisine[0]))}});var track=function(dishes){var ids=[];angular.forEach(dishes,function(dish){ids.push(dish.id)}),ids.length&&dishesFactory.view({menu_item_id:ids})};$scope.toggleSearch=function(){$scope.expandedSearch=!$scope.expandedSearch};var addingNewAddress=!1;$scope.addNewAddress=function(){$beacon.trigger("addAddress.modal.show"),$scope.user.addresses.length||$beacon.on("address.added",function(){openDishModalIfNeeded()||$rootScope.isMobileMode()||($scope.welcome_tour_start=!0)}),$modal.open({templateUrl:"/release/html/modals/account/addAddress.html",controller:"accountAddAddressCtrl",resolve:{controller:dependcyManager.resolve("controllers/accountAddAddressCtrl"),isFirst:function(){return!$scope.user.addresses.length},dishName:function(){return $scope.keyword},success:function(){return function(){addingNewAddress=!0,usersFactory.unpreferAnyAddress(),usersFactory.getCurrentUserFromAPI().then(function(){$beacon.trigger("address.added")})}},address:function(){return null}}})},$beacon.on("modal.closed",function(){$timeout(function(){$location.search("id",null)})});var openDishModalIfNeeded=function(){return $scope.data.filters.dish_id?(getDish($scope.data.filters.dish_id).then(function(result){var dish=result.dishes[0];$location.search().dislike?$scope.dislikeDialog(dish):$location.search().reviews?$scope.showReviews(dish):$scope.dishDetailsModal(dish)}),!0):!1};$scope.user.addresses.length>0?(openDishModalIfNeeded(),scheduleDishesReload("initial page load",$scope.data.page),getRestaurantsAndSectionsWithCounts(null,"initial page load")):($beacon.on("modal.closed",function(){$timeout(function(){addingNewAddress||($scope.no_address_tour_start=!0)},100)}),$scope.addNewAddress()),$scope.reloadDishes=function(page){var deferred=$q.defer();$scope.data.page=page||0,$scope.isAlreadyLoading=!0;for(var i in $scope.data.unapplied_filters)$scope.data.unapplied_filters.hasOwnProperty(i)&&($scope.data.unapplied_filters[i]=$scope.data.filters[i]);return $timeout(function(){$("input[type=range]").trigger("change","silent")}),setFiltersInUrl($scope.data.filters),$rootScope.session.last_selected_section_id=$scope.data.filters.section_id,getDishes().then(function(result){$scope.dishes=result.dishes,$scope.isAlreadyLoading=!1,deferred.resolve()}),deferred.promise},$scope.submit=function(){this.search.$setPristine(),$scope.data.filters.keyword=$scope.data.unapplied_filters.keyword},$scope.switchPage=function(direction){$scope.isAlreadyLoading||0>direction&&$scope.data.page<=0||direction>0&&$scope.isLastPage()||($rootScope.scrollToTop(),$scope.data.page+=direction,$scope.isAlreadyLoading=!0,getDishes().then(function(result){$scope.dishes=result.dishes,direction>0&&track($scope.dishes)}).finally(function(){$scope.isAlreadyLoading=!1}))},$scope.$watch("data.filters.keyword",function(newValue,oldValue){newValue!=oldValue&&(scheduleDishesReload("switched keyword"),getRestaurantsAndSectionsWithCounts(null,"new keyword search"))}),$scope.$watch("data.filters.cuisine_id",function(new_id,old_id){if(new_id!=old_id){for(var i in $scope.data.cuisines)if($scope.data.cuisines.hasOwnProperty(i)&&$scope.data.cuisines[i].id==new_id){$scope.cuisine=$scope.data.cuisines[i];break}getRestaurantsAndSectionsWithCounts(null,"cuisine changed"),$scope.resetFilters(["section_id","restaurant_id"],{cuisine_id:new_id})}}),$scope.$watch("data.filters.restaurant_id",function(new_id,old_id){if(new_id!=old_id){var restaurant={};for(var i in $scope.data.restaurants)$scope.data.restaurants.hasOwnProperty(i)&&$scope.data.restaurants[i].id==new_id&&(restaurant=$scope.data.restaurants[i]);($scope.data.filters.section_id||!old_id)&&($rootScope.session.last_selected_section_id=null),$scope.restaurant=restaurant,$scope.incomplete_order||getRestaurantsAndSectionsWithCounts(null,"restaurant changed"),restaurant?$scope.resetFilters(["section_id","restaurant_id"],{restaurant_id:restaurant.id}):$scope.resetFilters(["restaurant_id","section_id"])}}),$scope.$watch("data.filters.healthy.checked",function(value,oldValue){value!=oldValue&&($scope.data.sections=[],scheduleDishesReload("switched healthy"),getRestaurantsAndSectionsWithCounts(null,"healthy changed"))}),$scope.$watch("data.filters.section_id",function(new_id,old_id){if(new_id!=old_id){if(new_id){var section={name:new_id};for(var i in $scope.data.sections)if($scope.data.sections.hasOwnProperty(i)&&$scope.data.sections[i].id==new_id){section=$scope.data.sections[i];break}}$scope.section=section||{},scheduleDishesReload("switched section")}}),$scope.$watch("dishes",function(){$timeout(function(){$("li:not(.section-name) h1.section-name-to-move").each(function(){var parentLi=$(this).closest("li"),isFirst=0==parentLi.index();if(!parentLi.prev().is(".section-name")){var newItem=$("<li class='section-name'><h1 class='engraved "+(isFirst?" first ":"")+"'>"+$(this).html()+"</h1></li>");$(newItem).insertBefore(parentLi)}$(this).remove()})})}),$scope.$watch("user.address",function(address,old){!address||old&&old.id==address.id||(usersFactory.preferAddress({id:address.id}),scheduleDishesReload("switched user.address"),getRestaurantsAndSectionsWithCounts(null,"address changed"))});var timeLeftInterval=null;$scope.$watch("data.filters.location_id",function(newValue){angular.forEach($scope.user.addresses,function(address){if(address.id==newValue&&($scope.user.address=address,$scope.user.address.active_order_template)){var updateTimeLeft=function(){return $scope.user&&$scope.user.address.active_order_template?void($scope.data.time_left=new Date(2014,1,1,0,0,0).getTime()+1e3*$scope.user.address.active_order_template.close_at-new Date):void $interval.cancel(timeLeftInterval)};updateTimeLeft(),$interval.cancel(timeLeftInterval),timeLeftInterval=$interval(updateTimeLeft,1e3)}})}),$scope.dislikeDialog=function(dish){$modal.open({windowClass:"fullscreen-on-mobile",templateUrl:"/release/html/modals/dishes/dislike.html",controller:["$scope","$modalInstance","$rootScope","$timeout",function($modalScope,$modalInstance,$rootScope,$timeout){$modalScope.dish=dish,$(window).off("resize.dislikeDialog").on("resize.dislikeDialog",function(){if($rootScope.isMobileMode()){var modal=$(".modal.current .modal-dialog");$modalScope.choicesHeight=window.innerHeight-modal.height()+modal.find(".limited-height").height(),$modalScope.choicesMaxHeight=null}else $modalScope.choicesHeight=null,$modalScope.choicesMaxHeight=window.innerHeight-350});var initHeights=function(){var modal=$(".modal.current");modal.length?$(window).resize():$timeout(initHeights,100)};initHeights(),$modalScope.submit=function(){dishesFactory.dislike(dish),$error.success(null,"Successfully disliked. Updating your recommendations.",15e3,function(){dishesFactory.rate(dish,"regain").then(function(){$scope.reloadDishes()})}),$modalInstance.close(),$scope.reloadDishes()}}]})}}])});