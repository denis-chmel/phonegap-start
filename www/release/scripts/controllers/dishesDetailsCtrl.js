/*! Compiled on: Thu May 21 2015 08:13:23 */
var fileVersion = "v1.0-4-f842d9e-dirty"; 
"use strict";define(["modules/app","ordersFactory","iCheck"],function(app){app.controllerManager("dishesDetailsCtrl",function($scope,$rootScope,dish,ordersFactory,$modalInstance,$beacon,$loading,is_update,onSuccess,order,$timeout,$error){function flattenChoices(choices){return angular.forEach(choices,function(choice,i){choice.breadcrumb=choice.breadcrumb||[],choice.requirements="",choice.max_selection>1&&choice.max_selection==choice.min_selection?choice.requirements="choose exactly "+choice.max_selection:choice.max_selection>1&&choice.max_selection<choice.children.length?(choice.requirements="choose ",choice.min_selection>0&&(choice.requirements+="at least "+choice.min_selection+", but "),choice.requirements+="no more than "+choice.max_selection):choice.min_selection>1&&(choice.requirements="choose at least "+choice.min_selection),choice.getSelectedOptionIds=function(){if(!this.selected)return[];if(1==this.max_selection)return this.selected?[this.selected]:[];var chosen=[];return angular.forEach(this.selected,function(checked,id){checked&&chosen.push(id)}),chosen},choice.isChosen=function(option_id,value){var is_assign_mode="undefined"!=typeof value;if(1==this.max_selection){if(!is_assign_mode)return this.selected==option_id;this.selected=value?option_id:null}else{if(!is_assign_mode){var result=null;return angular.forEach(this.selected,function(checked,id){id==option_id&&(result=checked)}),result}this.selected=this.selected||{},this.selected[option_id]=value}},choice.type.indexOf("group")>-1&&(choice.isValid=function(){if(choice.isHidden&&choice.isHidden())return!0;if(1==this.max_selection)return this.min_selection?1==this.getSelectedOptionIds().length:!0;var checked_count=this.getSelectedOptionIds().length;return checked_count>=this.min_selection&&(!this.max_selection||checked_count<=this.max_selection)},angular.forEach(choice.children,function(option){angular.forEach(option.children,function(submenu){submenu.is_sublevel=1,submenu.breadcrumb=angular.copy(choice.breadcrumb),submenu.breadcrumb.push(option.name),submenu.isHidden=function(){return choice.isHidden&&choice.isHidden()?!0:"object"==typeof choice.selected?!choice.selected[option.id]:choice.selected!=option.id},choices.splice(i+1,0,submenu)})})),choice.children=flattenChoices(choice.children)}),choices}function addNoneOptions(choices){return angular.forEach(choices,function(choice){"option group"==choice.type&&0==choice.min_selection&&1==choice.max_selection&&choice.children.splice(0,0,{name:choice.name.match(/would you/i)?"No":"None"})}),choices}function preselectOptions(choices,chosen_option_ids,use_suggestions){return angular.forEach(choices,function(choice){chosen_option_ids&&angular.forEach(choice.children,function(option){chosen_option_ids.indexOf(option.id)>-1&&choice.isChosen(option.id,!0)}),choice.getSelectedOptionIds().length||use_suggestions&&angular.forEach(choice.children,function(option){option.suggested&&choice.isChosen(option.id,!0)})}),choices}$scope.show_validation_errors=!1,is_update&&(dish.item.notes=dish.notes);var dish_item=is_update?dish.item:dish;$scope.dish=angular.extend(dish_item,{options:[],recommended_modifications:dish.notes,base_price:dish_item.price,min_price:dish_item.min_price,final_price:Math.max(dish_item.price,dish_item.min_price),price_highlight:!1});var chosen_option_ids=[];is_update&&dish.options&&(chosen_option_ids=dish.options.split(",").map(function(option_id){return option_id})),$scope.dish.flatten_choices=flattenChoices(angular.copy($scope.dish.choices)),$scope.dish.flatten_choices=addNoneOptions($scope.dish.flatten_choices),$scope.dish.flatten_choices=preselectOptions($scope.dish.flatten_choices,chosen_option_ids,!is_update),$(window).off("resize.dishDetails").on("resize.dishDetails",function(){if($rootScope.isMobileMode()){var modal=$(".modal.current .modal-dialog");$scope.choicesHeight=window.innerHeight-modal.height()+modal.find(".limited-height").height(),$scope.choicesMaxHeight=null}else $scope.choicesHeight=null,$scope.choicesMaxHeight=window.innerHeight-350});var initHeights=function(){var modal=$(".modal.current");modal.length?$(window).resize():$timeout(initHeights,100)};initHeights(),$scope.dish.quantity=dish.quantity||1,$scope.updatePrice=function(){var old_price=$scope.dish.final_price;$scope.dish.final_price=parseFloat($scope.dish.base_price),angular.forEach($scope.dish.flatten_choices,function(choice){var chosen_ids=choice.getSelectedOptionIds();angular.forEach(choice.children,function(options){chosen_ids.indexOf(options.id)>-1&&($scope.dish.final_price+=parseFloat(options.price))})}),$scope.dish.final_price=Math.max($scope.dish.final_price,$scope.dish.min_price),old_price!=$scope.dish.final_price&&($scope.dish.price_highlight=!0,$timeout(function(){$scope.dish.price_highlight=!1},150))},$scope.updatePrice(),$scope.submit=function(){var params={address_id:$scope.dish.address_id,restaurant_id:$scope.dish.restaurant_id,menu_item_id:$scope.dish.id,menu_item_price:$scope.dish.final_price,notes:this.detailsForm.notes.$modelValue,quantity:parseInt($scope.dish.quantity),option_ids:""},options=[];angular.forEach($scope.dish.flatten_choices,function(choice){options=options.concat(choice.getSelectedOptionIds())}),options.length>0&&(params.option_ids=options.join(",")),$loading.start(),is_update?(params.order_item_id=dish.id,params.item_id=dish.item_id,params.id=dish.order_id,params.token=dish.order_token,ordersFactory.updateItem(params).then(function(){$modalInstance.close(),$loading.end()},function(error){$loading.end(),$scope.show_validation_errors=!0,$error.alert(null,error.data.data)})):ordersFactory.add(params).then(function(){$loading.end(),$modalInstance.close(),Modernizr.touch&&$rootScope.scrollToTop(1),$beacon.trigger("dish.added",[dish,$rootScope.incomplete_order]),onSuccess&&onSuccess(dish)},function(error){$loading.end(),$scope.show_validation_errors=!0,$error.alert(null,error.data.data)})}})});