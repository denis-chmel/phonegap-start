/*! Compiled on: Thu May 21 2015 09:02:39 */
var fileVersion = "v1.0-4-f842d9e-dirty"; 
"use strict";define(["angular","utils/dependcyManager","localConfig","cookies","angularRoute","angularAnimate","angularSanitize","angularResource","cachedResource","angularUIRouter","angularTouch","modal","beacon","error","loading"],function(angular,dependcyManager){var localConfig=angular.injector(["localConfig"]).get("config"),defaultConfig={version:"undefined"!=typeof fileVersion?fileVersion:(new Date).getTime(),devMode:!1,cache:!0,urlDebugMode:!1,mixpanelPretend:!1,mixpanelId:"68037b1f2e39918b8b816a6db258a799",dietsMaxNumber:1,maxMinPrice:30,maxMinOrder:21,facebookAppId:"1436535709919546",api:"https://api.gobask.com/v1"},appConfig=angular.extend({},defaultConfig,localConfig),app=angular.module("app",["localConfig","ngResource","ngRoute","ui.router","cookies","ngSanitize","ngAnimate","ngTouch","ui.modal","beacon","error","ngCachedResource","loading"],function($compileProvider,$controllerProvider,$provide,$filterProvider){app.decoratorManager=$provide.decorator,app.factoryManager=$provide.factory,app.filterManager=$filterProvider.register,app.directiveManager=$compileProvider.directive,app.compileManager=$compileProvider,app.controllerManager=$controllerProvider.register,app.constantManager=$provide.constant,app.controller=$controllerProvider.register,app.directive=$compileProvider.directive,app.filter=$filterProvider.register,app.factory=$provide.factory,app.service=$provide.service,app.controllerManager("app",["$rootScope","config","$scope","$state","$location","$injector","$beacon","$loading","usersFactory","$modal","$error","$cookies","$timeout",function($rootScope,config,$scope,$state,$location,$injector,$beacon,$loading,usersFactory,$modal,$error,$cookies,$timeout){$rootScope.config=config,$rootScope.email=($location.search().email||"").replace(/ /g,"+"),$rootScope.login_message=($location.search().message||"").replace(/\+/g," "),$rootScope.successMessage=$location.search().success,$rootScope.global={below_order_minimum:0},$location.search().diet&&$cookies.set("pdiet",$location.search().diet),$rootScope.Math=Math,$rootScope.data={bgClass:"bg5"};var isFramePage=$location.$$path.match(/^\/frame/);$rootScope.$on("$stateChangeStart",function(event,toState){if("frame"!=toState.data.class){var isInFrame=window.self!==window.top;if(isInFrame)return void(window.parent.location=toState.url)}var isLogged=$cookies.get("access_token")&&$cookies.get("refresh_token");if("primary.home"!=toState.name||$location.search().error)isLogged||toState.data.guest_mode||($beacon.trigger("authentication.change",!0),event.preventDefault(),$rootScope.user&&($rootScope.email=$rootScope.user.email),$rootScope.after_sign_in_url=$location.$$url,$state.transitionTo("primary.home").then(function(){$rootScope.login_message||$error.success(null,"Your last session has expired, please sign in again to continue.")}));else{var goToDishes=function(){};isLogged?goToDishes():usersFactory.getCurrentUserFromAPI().then(function(user){user&&goToDishes()})}});var isPasswordReset=$location.search().code;isPasswordReset&&$modal.open({templateUrl:"/release/html/modals/account/resetPassword.html",windowClass:"forgot-details",resolve:{controller:dependcyManager.resolve("controllers/resetPasswordCtrl")},controller:"resetPasswordCtrl"}),$rootScope.scrollToTop=function(withAnimation){$("body, html").stop().animate({scrollTop:0},withAnimation?800:0)},$rootScope.isMobileMode=function(){return!0},$rootScope.delay=function(){var timers={"default":0};return function(callback,ms,context){context=context||"default",clearTimeout(timers[context]),timers[context]=setTimeout(callback,ms)}}();var set_paleo_diet_automatically=!1;$rootScope.show_splash=!1,$timeout(function(){$rootScope.show_splash=!0},1300),$rootScope.$on("$stateChangeSuccess",function(event,current){"primary.paleo"==current.name&&(set_paleo_diet_automatically=!0),"primary.gluten-free"==current.name&&$cookies.remove("pdiet"),$rootScope.preselectedDiet=parseInt($cookies.get("pdiet")||0);var isRootPage="/"==$location.$$url||$location.$$url.match(/^\/\?/);if(isRootPage||isFramePage||current.data.guest_mode||isPasswordReset||usersFactory.getCurrentUserFromAPI().then({},function(){var dishName=($location.search().search||"").replace(/\+/g," ");return $location.search().id&&!$rootScope.login_message&&$modal.open({templateUrl:"/release/html/modals/confirm.html",windowClass:"welcomeModal",controller:function($scope,$modalInstance){var dishNameReference=dishName?"<em>"+dishName+"</em>":"the dish";$scope.header="Welcome to Bask!",$scope.body="Please login or sign up to order "+dishNameReference+" now.",$scope.close=function(){$modalInstance.close()}}}),$location.url("/?error=sign-in-first")}),$rootScope.hideCart=!0,$rootScope.route_name=current.name,$rootScope.uiState=current.data.class.split(" ")[0],$rootScope.uiPageClass=current.data.class,$rootScope.cartEnabled=current.data.noCart===!1,$rootScope.openFilters=!1,$rootScope.scrollToTop(),$rootScope.successMessage){var text;switch($rootScope.successMessage){case"NEVER_SUBSCRIBED":case"ALREADY_UNSUBSCRIBED":case"SUCCESSFULLY_UNSUBSCRIBED":text="You have been unsubscribed."}text&&($error.success("success",text),$rootScope.successMessage=null)}var path=$location.path();return"/"===path.charAt(path.length-1)?path.substr(0,path.length-1):void 0}),require(["authenticationFactory"],function(){var authenticationFactory=$injector.get("authenticationFactory");$beacon.on("authentication.logout",function(){$cookies.remove("pdiet")}),$beacon.on("authentication.logged",function(){isPasswordReset||($rootScope.email=null,$rootScope.login_message=null,angular.extend($rootScope.session.mixpanel_properties,{"User Id":$rootScope.user.id,Email:$rootScope.user.email}),$location.search().email&&$location.search("email",null),$location.search().message&&$location.search("message",null))});var resetSessionVars=function(){$rootScope.session={last_selected_section_id:null,mixpanel_properties:{}}};resetSessionVars(),$beacon.on("authentication.change",function(){resetSessionVars(),authenticationFactory.me().then(function(user){if($rootScope.user=user,$beacon.trigger("user.loggedin",[user]),$rootScope.after_sign_in_url){var url=$rootScope.after_sign_in_url;$rootScope.after_sign_in_url=null,$location.url(url)}var isNewUser=0==user.ratings.length;isNewUser&&(set_paleo_diet_automatically?usersFactory.update({diets:[8]}).then(function(){$state.transitionTo("primary.tastes")}):$state.transitionTo("primary.diets")),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState){"primary.home"==fromState.name&&($loading.end(),$modal.closeAll())})},function(){$rootScope.user=null})}),authenticationFactory.me().then(function(user){$rootScope.user=user}),$rootScope.signIn=function(email,password){var params={email:email||this.email,password:password||this.password};return params.email?params.password?authenticationFactory.signIn(params):void $error.alert("email","Please enter your password."):void $error.alert("email","Please enter a valid email address.")},$scope.signout=function(){authenticationFactory.signout(),$state.transitionTo("primary.home")}})}])}).constant("config",appConfig);return app.factory("errorInterceptor",["$q","$loading","$error","$cookies",function($q,$loading,$error,$cookies){return{responseError:function(response){return 400==response.status&&"The refresh token is invalid."==response.data.error&&($cookies.remove("refresh_token"),window.location.reload()),401==response.status&&($cookies.remove("token_expiry"),$cookies.get("refresh_token")&&$cookies.get("access_token")&&window.location.reload()),$loading.end(),response.data&&response.data.data&&$error.alert(null,response.data.data),$q.reject(response)}}}]),app.config(["$httpProvider",function($httpProvider){var authHttpInterceptor=["$q","$injector","$cookies",function($q,$injector,$cookies){var refresh_promise=null,refreshAccessToken=function(){return refresh_promise||(refresh_promise=$q.defer(),require(["authenticationFactory"],function(){var authenticationFactory=$injector.get("authenticationFactory");authenticationFactory.refreshAccessToken().then(function(){refresh_promise.resolve()},function(){refresh_promise.reject()})})),refresh_promise.promise};return{request:function(config){return"GET"==config.method&&(config.url+=(config.url.indexOf("?")>-1?"&":"?")+"v="+appConfig.version),appConfig.urlDebugMode&&console.info(config.method+" request:",config),config.authentication===!0&&$cookies.has("refresh_token")&&$cookies.has("access_token")?$cookies.has("token_expiry")?(config.headers.Authorization=$cookies.get("access_token"),config):refreshAccessToken().then(function(){return config.headers.Authorization=$cookies.get("access_token"),config}):config.authentication===!0?$cookies.has("access_token")?config||$q.when(config):$q.reject("Access token is missing"):config||$q.when(config)}}}];if($httpProvider.interceptors.push(authHttpInterceptor),$httpProvider.interceptors.push("errorInterceptor"),appConfig.devMode){var neverCacheInterceptor=["$q",function(){return{request:function(config){return requirejs.s.contexts._.config.baseUrl="/src/scripts/",config.url=config.url.replace(/release\/html/,"src/html"),config},response:function(response){return response}}}];$httpProvider.interceptors.push(neverCacheInterceptor)}}]),app});